#!/bin/bash

# Main pre-push hook runner
# Executes all executable scripts in the pre-push.d directory

HOOK_DIR="$(dirname "$0")/pre-push.d"

# Store stdin in a temp file since multiple hooks need to read it
temp_stdin=$(mktemp)
cat > "$temp_stdin"

cleanup() {
    rm -f "$temp_stdin"
}

# Register cleanup to run on script exit (success, failure, or interrupt)
trap cleanup EXIT

# Check if pre-push.d directory exists
if [ ! -d "$HOOK_DIR" ]; then
    echo "No pre-push hooks directory found at $HOOK_DIR"
    exit 0
fi

echo "üèÉ Running pre-push hooks from $HOOK_DIR"

# Run each executable script in the directory
for hook in "$HOOK_DIR"/*; do
    if [ -f "$hook" ] && [ -x "$hook" ]; then
        hook_name=$(basename "$hook")
        echo "üèÉ pre-push($hook_name): Starting..."
        
        # Pass the captured stdin to each hook
        if ! "$hook" < "$temp_stdin"; then
            echo "‚ùå pre-push($hook_name): Failed"
            exit 1
        else
            echo "‚úÖ pre-push($hook_name): Completed successfully"
        fi
    fi
done